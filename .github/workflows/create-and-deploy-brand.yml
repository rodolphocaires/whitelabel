name: Create and Deploy New Brand

on:
  workflow_dispatch:
    inputs:
      brand_id:
        description: 'Brand ID (unique identifier, lowercase, no spaces)'
        required: true
        type: string
      brand_config:
        description: 'Brand Configuration JSON (see example in workflow description)'
        required: true
        type: string
      platform:
        description: 'Platform to deploy'
        required: true
        default: 'both'
        type: choice
        options:
          - ios
          - android
          - both
      build_mode:
        description: 'Build mode'
        required: true
        default: 'release'
        type: choice
        options:
          - debug
          - release

jobs:
  create-brand:
    runs-on: ubuntu-latest
    outputs:
      brand_id: ${{ github.event.inputs.brand_id }}
      
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        token: ${{ secrets.GITHUB_TOKEN }}

    - name: Parse and validate brand configuration
      id: parse_config
      run: |
        BRAND_ID="${{ github.event.inputs.brand_id }}"
        
        # Validate brand ID
        if [[ ! "$BRAND_ID" =~ ^[a-z0-9_]+$ ]]; then
          echo "‚ùå Brand ID must be lowercase letters, numbers, and underscores only"
          exit 1
        fi
        if [ -d "assets/brands/$BRAND_ID" ]; then
          echo "‚ùå Brand ID '$BRAND_ID' already exists"
          exit 1
        fi
        echo "‚úÖ Brand ID '$BRAND_ID' is valid"
        
        # Parse JSON configuration
        CONFIG='${{ github.event.inputs.brand_config }}'
        echo "Parsing brand configuration..."
        
        # Validate JSON format
        if ! echo "$CONFIG" | jq . > /dev/null 2>&1; then
          echo "‚ùå Invalid JSON format in brand configuration"
          exit 1
        fi
        
        # Extract and validate required fields
        BRAND_NAME=$(echo "$CONFIG" | jq -r '.brandName // empty')
        APP_TITLE=$(echo "$CONFIG" | jq -r '.appTitle // empty')
        PRIMARY_COLOR=$(echo "$CONFIG" | jq -r '.primaryColorHex // empty')
        SPLASH_URL=$(echo "$CONFIG" | jq -r '.splashScreenUrl // empty')
        API_URL=$(echo "$CONFIG" | jq -r '.customSettings.apiBaseUrl // empty')
        SUPPORT_EMAIL=$(echo "$CONFIG" | jq -r '.customSettings.supportEmail // empty')
        
        if [ -z "$BRAND_NAME" ] || [ -z "$APP_TITLE" ] || [ -z "$PRIMARY_COLOR" ] || [ -z "$SPLASH_URL" ] || [ -z "$API_URL" ] || [ -z "$SUPPORT_EMAIL" ]; then
          echo "‚ùå Missing required fields in configuration"
          echo "Required: brandName, appTitle, primaryColorHex, splashScreenUrl, customSettings.apiBaseUrl, customSettings.supportEmail"
          exit 1
        fi
        
        # Validate color formats
        COLORS=(
          "$(echo "$CONFIG" | jq -r '.primaryColorHex // "#000000"')"
          "$(echo "$CONFIG" | jq -r '.secondaryColorHex // "#000000"')"
          "$(echo "$CONFIG" | jq -r '.accentColorHex // "#000000"')"
          "$(echo "$CONFIG" | jq -r '.backgroundColorHex // "#FFFFFF"')"
          "$(echo "$CONFIG" | jq -r '.textColorHex // "#000000"')"
        )
        
        for color in "${COLORS[@]}"; do
          if [[ ! "$color" =~ ^#[0-9A-Fa-f]{6}$ ]]; then
            echo "‚ùå Invalid color format: $color (must be #RRGGBB)"
            exit 1
          fi
        done
        
        echo "‚úÖ Brand configuration is valid"
        
        # Export parsed values for later steps
        echo "BRAND_NAME=$BRAND_NAME" >> $GITHUB_OUTPUT
        echo "APP_TITLE=$APP_TITLE" >> $GITHUB_OUTPUT
        echo "PRIMARY_COLOR=$PRIMARY_COLOR" >> $GITHUB_OUTPUT
        echo "SPLASH_URL=$SPLASH_URL" >> $GITHUB_OUTPUT
        echo "API_URL=$API_URL" >> $GITHUB_OUTPUT
        echo "SUPPORT_EMAIL=$SUPPORT_EMAIL" >> $GITHUB_OUTPUT

    - name: Create brand directory structure
      run: |
        BRAND_ID="${{ github.event.inputs.brand_id }}"
        mkdir -p "assets/brands/$BRAND_ID"
        
        # Create placeholder assets
        touch "assets/brands/$BRAND_ID/logo.png"
        touch "assets/brands/$BRAND_ID/splash_bg.png"
        
        echo "‚úÖ Created brand directory structure for $BRAND_ID"

    - name: Generate brand configuration
      run: |
        BRAND_ID="${{ github.event.inputs.brand_id }}"
        CONFIG_FILE="assets/brands/$BRAND_ID/config.json"
        
        # Use the provided JSON configuration with brand ID path updates
        CONFIG='${{ github.event.inputs.brand_config }}'
        
        # Update asset paths to include the brand ID
        UPDATED_CONFIG=$(echo "$CONFIG" | jq --arg brand_id "$BRAND_ID" '
          .logoPath = "assets/brands/\($brand_id)/" + (.logoPath // "logo.png") |
          .assets.logo = "assets/brands/\($brand_id)/" + (.logoPath // "logo.png") |
          .assets.splash_background = "assets/brands/\($brand_id)/splash_bg.png" |
          .assets.app_icon = "assets/brands/\($brand_id)/logo.png"
        ')
        
        # Write the configuration to file
        echo "$UPDATED_CONFIG" | jq '.' > "$CONFIG_FILE"
        
        echo "‚úÖ Generated brand configuration:"
        cat "$CONFIG_FILE" | jq '.'

    - name: Update pubspec.yaml with new brand assets
      run: |
        BRAND_ID="${{ github.event.inputs.brand_id }}"
        
        # Check if brand assets path already exists in pubspec.yaml
        if ! grep -q "assets/brands/$BRAND_ID/" pubspec.yaml; then
          # Add new brand assets path
          sed -i "/- assets\/brands\/active\//a\\    - assets/brands/$BRAND_ID/" pubspec.yaml
          echo "‚úÖ Added $BRAND_ID assets to pubspec.yaml"
        else
          echo "‚ÑπÔ∏è Brand assets already in pubspec.yaml"
        fi

    - name: Commit new brand configuration
      run: |
        BRAND_ID="${{ github.event.inputs.brand_id }}"
        
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action"
        
        git add "assets/brands/$BRAND_ID/"
        git add "pubspec.yaml"
        
        git commit -m "üé® Add new brand: ${{ github.event.inputs.brand_name }} ($BRAND_ID)

        Brand Configuration:
        - Brand Name: ${{ github.event.inputs.brand_name }}
        - App Title: ${{ github.event.inputs.app_title }}
        - Primary Color: ${{ github.event.inputs.primary_color }}
        - API Base URL: ${{ github.event.inputs.api_base_url }}
        - Support Email: ${{ github.event.inputs.support_email }}
        
        Created via GitHub Actions workflow"
        
        git push
        
        echo "‚úÖ Committed and pushed new brand configuration"

    - name: Display brand summary
      run: |
        echo "üéâ Brand Creation Summary"
        echo "========================"
        echo "Brand ID: ${{ github.event.inputs.brand_id }}"
        echo "Brand Name: ${{ steps.parse_config.outputs.BRAND_NAME }}"
        echo "App Title: ${{ steps.parse_config.outputs.APP_TITLE }}"
        echo "Primary Color: ${{ steps.parse_config.outputs.PRIMARY_COLOR }}"
        echo "Splash Screen URL: ${{ steps.parse_config.outputs.SPLASH_URL }}"
        echo "API Base URL: ${{ steps.parse_config.outputs.API_URL }}"
        echo "Support Email: ${{ steps.parse_config.outputs.SUPPORT_EMAIL }}"
        echo "Platform: ${{ github.event.inputs.platform }}"
        echo "Build Mode: ${{ github.event.inputs.build_mode }}"

  deploy-ios:
    if: ${{ github.event.inputs.platform == 'ios' || github.event.inputs.platform == 'both' }}
    needs: create-brand
    runs-on: macos-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        ref: ${{ github.ref }}

    - name: Pull latest changes
      run: git pull origin ${{ github.ref_name }}

    - name: Setup Flutter
      uses: subosito/flutter-action@v2
      with:
        flutter-version: '3.35.2'
        channel: 'stable'

    - name: Setup Ruby
      uses: ruby/setup-ruby@v1
      with:
        ruby-version: '3.0'
        bundler-cache: true
        working-directory: fastlane

    - name: Install dependencies
      run: |
        flutter pub get
        dart run build_runner build --delete-conflicting-outputs

    - name: Deploy iOS - ${{ needs.create-brand.outputs.brand_id }}
      env:
        FASTLANE_APPLE_APPLICATION_SPECIFIC_PASSWORD: ${{ secrets.FASTLANE_APPLE_APPLICATION_SPECIFIC_PASSWORD }}
        FASTLANE_SESSION: ${{ secrets.FASTLANE_SESSION }}
        FASTLANE_USER: ${{ secrets.FASTLANE_USER }}
        MATCH_PASSWORD: ${{ secrets.MATCH_PASSWORD }}
      run: |
        cd fastlane
        bundle exec fastlane ios deploy_brand brand_id:${{ needs.create-brand.outputs.brand_id }}

    - name: Upload iOS artifacts
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: ios-${{ needs.create-brand.outputs.brand_id }}-${{ github.event.inputs.build_mode }}
        path: |
          build/ios/iphoneos/*.app
          build/ios/iphoneos/*.ipa
        retention-days: 30

  deploy-android:
    if: ${{ github.event.inputs.platform == 'android' || github.event.inputs.platform == 'both' }}
    needs: create-brand
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        ref: ${{ github.ref }}

    - name: Pull latest changes
      run: git pull origin ${{ github.ref_name }}

    - name: Setup Java
      uses: actions/setup-java@v4
      with:
        distribution: 'zulu'
        java-version: '17'

    - name: Setup Flutter
      uses: subosito/flutter-action@v2
      with:
        flutter-version: '3.35.2'
        channel: 'stable'

    - name: Setup Ruby
      uses: ruby/setup-ruby@v1
      with:
        ruby-version: '3.0'
        bundler-cache: true
        working-directory: fastlane

    - name: Install dependencies
      run: |
        flutter pub get
        dart run build_runner build --delete-conflicting-outputs

    - name: Setup Android signing
      env:
        ANDROID_KEYSTORE_BASE64: ${{ secrets.ANDROID_KEYSTORE_BASE64 }}
        ANDROID_KEYSTORE_PASSWORD: ${{ secrets.ANDROID_KEYSTORE_PASSWORD }}
        ANDROID_KEY_ALIAS: ${{ secrets.ANDROID_KEY_ALIAS }}
        ANDROID_KEY_PASSWORD: ${{ secrets.ANDROID_KEY_PASSWORD }}
      run: |
        echo "$ANDROID_KEYSTORE_BASE64" | base64 --decode > android/app/keystore.jks
        cat > android/key.properties << EOF
        storePassword=$ANDROID_KEYSTORE_PASSWORD
        keyPassword=$ANDROID_KEY_PASSWORD
        keyAlias=$ANDROID_KEY_ALIAS
        storeFile=keystore.jks
        EOF

    - name: Deploy Android - ${{ needs.create-brand.outputs.brand_id }}
      env:
        GOOGLE_PLAY_SERVICE_ACCOUNT_JSON: ${{ secrets.GOOGLE_PLAY_SERVICE_ACCOUNT_JSON }}
      run: |
        echo "$GOOGLE_PLAY_SERVICE_ACCOUNT_JSON" > fastlane/service_account.json
        
        cd fastlane
        bundle exec fastlane android deploy_brand brand_id:${{ needs.create-brand.outputs.brand_id }}

    - name: Upload Android artifacts
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: android-${{ needs.create-brand.outputs.brand_id }}-${{ github.event.inputs.build_mode }}
        path: |
          build/app/outputs/flutter-apk/*.apk
          build/app/outputs/bundle/release/*.aab
        retention-days: 30

  summary:
    needs: [create-brand, deploy-ios, deploy-android]
    if: always()
    runs-on: ubuntu-latest
    
    steps:
    - name: Deployment Summary
      run: |
        echo "üéâ Brand Creation and Deployment Complete!"
        echo "=========================================="
        echo "Brand ID: ${{ needs.create-brand.outputs.brand_id }}"
        echo "Platform: ${{ github.event.inputs.platform }}"
        echo "Build Mode: ${{ github.event.inputs.build_mode }}"
        echo ""
        echo "Deployment Status:"
        echo "- iOS: ${{ needs.deploy-ios.result || 'Skipped' }}"
        echo "- Android: ${{ needs.deploy-android.result || 'Skipped' }}"
        echo ""
        echo "Configuration committed to repository ‚úÖ"
        echo "Build artifacts uploaded ‚úÖ"
